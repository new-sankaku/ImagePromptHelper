<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>階層的タグ選択UI（画像キャッシュ機能付き）</title>
  <link rel="stylesheet" href="css/main.css?v=1.0">
  <script src="https://unpkg.com/i18next@21.9.1/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@1.4.3/i18nextHttpBackend.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <style>
  </style>
</head>

<body>
  <div class="container">
    <div class="dropdown-container">
      <select id="languageDropdown" class="dropdown">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
      <select id="modelDropdown" class="dropdown">
        <option value="Pony">Pony</option>
        <option value="SDXL">SDXL</option>
      </select>
    </div>
    <div class="upper-section">
      <div class="column column-2">
        <h3>カテゴリ</h3>
        <div id="tag1Container" class="scroll-area"></div>
      </div>
      <div class="column column-6">
        <h3>中項目</h3>
        <div id="tagLevels" class="scroll-area"></div>
      </div>
      <div class="column column-2">
        <h3>
          選択済み
          <button id="downloadButton" class="icon-button" disabled title="ダウンロード">
            <i class="fas fa-download"></i>
          </button>
          <button id="copyButton" class="icon-button" disabled title="コピー">
            <i class="fas fa-copy"></i>
          </button>
        </h3>
        <div id="selectedTags" class="scroll-area"></div>
      </div>
    </div>
    <div id="imageContainer"></div>
  </div>

  <script>
    let data = {};
    let currentPath = [];
    let selectedTagGroups = [];
    let selectedImages = [];
    let imageCache = new Map();
    let imageWrappers = [];

    document.addEventListener('DOMContentLoaded', initializeUI);

    function initializeUI() {
      const languageDropdown = document.getElementById('languageDropdown');
      const modelDropdown = document.getElementById('modelDropdown');
      languageDropdown.addEventListener('change', () => loadJson());
      modelDropdown.addEventListener('change', () => loadJson());

      loadJson();
      showTag1();

      document.getElementById('downloadButton').addEventListener('click', () => {
        if (selectedTagGroups.length > 0) {
          const content = selectedTagGroups.join(',');
          const blob = new Blob([content], { type: 'text/plain' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'selected_tags.txt';
          a.click();
        }
      });

      document.getElementById('copyButton').addEventListener('click', () => {
        if (selectedTagGroups.length > 0) {
          const content = selectedTagGroups.join(',');
          navigator.clipboard.writeText(content).then(() => {
          }).catch(err => {
            console.error('クリップボードへのコピーに失敗しました:', err);
          });
        }
      });
    }

    function loadJson() {
      const language = document.getElementById('languageDropdown').value;
      const model = document.getElementById('modelDropdown').value;
      const filename = `json/prompt_${model.toLowerCase()}_${language}.json`;

      fetch(filename)
        .then(response => response.json())
        .then(jsonData => {
          data = jsonData;
          currentPath = [];
          selectedTagGroups = [];
          selectedImages = [];
          showTag1();
          updateSelectedTagsDisplay();
          updateImageDisplay();
        })
        .catch(error => console.error('Error loading JSON:', error));
    }

    function showTag1() {
      const tag1Container = document.getElementById('tag1Container');
      tag1Container.innerHTML = '';
      Object.keys(data).forEach(tag => {
        if (tag === "hr") {
          const hr = document.createElement('hr');
          tag1Container.appendChild(hr);
        } else {
          const button = createButton(tag, 1);
          button.addEventListener('click', () => selectTag(tag, 0, data[tag]));
          tag1Container.appendChild(button);
        }
      });
    }

    function createButton(text, level, url) {
      const button = document.createElement('button');
      button.classList.add('tag-button', `tag${level}-button`);
      if (url) {
        const placeholder = document.createElement('div');
        placeholder.classList.add('image-placeholder');
        placeholder.textContent = '読み込み中';
        
        button.appendChild(placeholder);

        loadImage(url).then(img => {
          placeholder.remove();
          button.insertBefore(img, button.firstChild);
        }).catch(() => {
          placeholder.textContent = '画像を読み込めません';
        });
      }
      const span = document.createElement('span');
      span.textContent = text;
      button.appendChild(span);
      return button;
    }

    function loadImage(url) {
      if (imageCache.has(url)) {
        return Promise.resolve(imageCache.get(url).cloneNode());
      }

      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          imageCache.set(url, img);
          resolve(img.cloneNode());
        };
        img.onerror = reject;
        img.src = url;
        img.alt = "";
      });
    }

    function showTags(currentData, level) {
      const tagLevels = document.getElementById('tagLevels');

      while (tagLevels.children.length > level) {
        tagLevels.removeChild(tagLevels.lastChild);
      }

      const levelContainer = document.createElement('div');

      const buttons = Object.keys(currentData).map(tag => {
        const url = currentData[tag].url || (typeof currentData[tag] === 'object' && currentData[tag].hasOwnProperty('url') ? currentData[tag].url : null);
        const button = createButton(tag, level + 1, url);
        button.addEventListener('click', () => selectTag(tag, level, currentData[tag]));
        return button;
      });

      Promise.all(buttons.map(button => {
        const img = button.querySelector('img');
        return img ? loadImage(img.src) : Promise.resolve();
      })).then(() => {
        buttons.forEach(button => levelContainer.appendChild(button));
        tagLevels.appendChild(levelContainer);
      });
    }

    function selectTag(tag, level, data) {
      const tagLevels = document.getElementById('tagLevels');
      while (tagLevels.children.length > level) {
        tagLevels.removeChild(tagLevels.lastChild);
      }

      currentPath = currentPath.slice(0, level);
      currentPath.push(tag);

      if (typeof data === 'object' && !data.hasOwnProperty('Desc')) {
        showTags(data, level + 1);
      } else {
        finishSelection(tag, data);
      }
    }

    function finishSelection(tag, item) {
      addSelectedTag(tag);
      addImage(item.url);
      currentPath = [];
    }

    function addSelectedTag(tag) {
      selectedTagGroups.push(tag);
      updateSelectedTagsDisplay();
    }

    function updateSelectedTagsDisplay() {
      const selectedTagsElement = document.getElementById('selectedTags');
      selectedTagsElement.innerHTML = '';
      selectedTagGroups.forEach((tag, index) => {
        const groupElement = document.createElement('span');
        groupElement.classList.add('selected-tag-group');
        groupElement.textContent = tag;
        groupElement.addEventListener('click', () => removeTagGroup(index));
        const removeButton = document.createElement('span');
        removeButton.classList.add('remove-tag');
        removeButton.innerHTML = '<i class="fas fa-times"></i>';
        removeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          removeTagGroup(index);
        });
        groupElement.appendChild(removeButton);
        selectedTagsElement.appendChild(groupElement);
      });

      const downloadButton = document.getElementById('downloadButton');
      const copyButton = document.getElementById('copyButton');
      const hasSelectedTags = selectedTagGroups.length > 0;
      downloadButton.disabled = !hasSelectedTags;
      copyButton.disabled = !hasSelectedTags;
    }

    function removeTagGroup(index) {
      selectedTagGroups.splice(index, 1);
      selectedImages.splice(index, 1);
      const imageWrapper = imageWrappers[index];
      if (imageWrapper) {
        imageWrapper.remove();
        imageWrappers.splice(index, 1);
        updateImageIndices();
      }
      updateSelectedTagsDisplay();
    }

    function updateImageIndices() {
      imageWrappers.forEach((wrapper, index) => {
        const removeButton = wrapper.querySelector('.remove-tag');
        removeButton.onclick = (e) => {
          e.stopPropagation();
          removeTagGroup(index);
        };
        wrapper.querySelector('img').onclick = () => removeTagGroup(index);
      });
    }

    function addImage(url) {
      if (url) {
        selectedImages.push(url);
        const imageContainer = document.getElementById('imageContainer');
        const index = selectedImages.length - 1;

        loadImage(url).then(img => {
          const wrapper = createImageWrapper(url, index);
          imageContainer.appendChild(wrapper);
          imageWrappers.push(wrapper);
          updateImageIndices();
        });
      }
    }

    function createImageWrapper(url, index) {
      const imageWrapper = document.createElement('div');
      imageWrapper.classList.add('image-container');

      const imgElement = document.createElement('img');
      imgElement.src = url;

      const removeButton = document.createElement('span');
      removeButton.classList.add('remove-tag');
      removeButton.innerHTML = '<i class="fas fa-times"></i>';

      imageWrapper.appendChild(imgElement);
      imageWrapper.appendChild(removeButton);
      return imageWrapper;
    }

    function updateImageDisplay() {
      const imageContainer = document.getElementById('imageContainer');
      imageContainer.innerHTML = '';
      imageWrappers = [];

      selectedImages.forEach((url, index) => {
        loadImage(url).then(img => {
          const wrapper = createImageWrapper(url, index);
          imageContainer.appendChild(wrapper);
          imageWrappers.push(wrapper);
        });
      });
    }
  </script>
</body>

</html>