<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>階層的タグ選択UI（画像キャッシュ機能付き）</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #1a1a1a;
      color: #ffffff;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .upper-section {
      display: flex;
      flex: 1;
      border-bottom: 1px solid #333;
    }

    .column {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      padding: 10px;
    }

    .column:last-child {
      border-right: none;
    }

    .column-2 {
      flex: 2;
    }

    .column-6 {
      flex: 6;
    }

    .column-3 {
      flex: 3;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #ddd;
    }

    .scroll-area {
      flex-grow: 1;
      overflow-y: auto;
    }

    .tag-button {
      display: inline-block;
      padding: 8px 15px;
      margin: 0 5px 5px 0;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.3);
      border: 2px solid;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .tag-button:hover {
      box-shadow: 0 0 15px currentColor;
    }

    .tag-button img {
      max-width: 100px;
      max-height: 100px;
      display: block;
      margin: 0 auto 5px;
    }

    .tag1-button {
      border-color: #ff6b6b;
      color: #ff6b6b;
    }

    .tag2-button {
      border-color: #4ecdc4;
      color: #4ecdc4;
    }

    .tag3-button {
      border-color: #45b7d1;
      color: #45b7d1;
    }

    .tag4-button {
      border-color: #f7b731;
      color: #f7b731;
    }

    .tag5-button {
      border-color: #a55eea;
      color: #a55eea;
    }

    #imageContainer {
      height: 200px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      padding: 2px;
      overflow-y: auto;
      background-color: #2a2a2a;
    }

    #imageContainer img {
      width: 180px;
      height: 180px;
      object-fit: contain;
      margin: 2px;
      border: 1px solid #444;
      border-radius: 5px;
    }

    .image-placeholder {
      width: 180px;
      height: 180px;
      background-color: #444;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #888;
      font-size: 14px;
      margin: 2px;
      border-radius: 5px;
    }

    .selected-tag-group {
      display: inline-block;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      padding: 5px;
      margin: 0 5px 5px 0;
    }

    .remove-tag {
      cursor: pointer;
      color: #ff6b6b;
      margin-left: 5px;
    }

    hr {
      border: none;
      height: 1px;
      background-color: #333;
      margin: 10px 0;
    }

    .dropdown-container {
      display: flex;
      justify-content: flex-end;
      padding: 10px;
      border-bottom: 1px solid #333;
    }

    .dropdown {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 5px;
      margin: 0 5px;
    }

    /* Scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #2a2a2a;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
  <script src="https://unpkg.com/i18next@21.9.1/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@1.4.3/i18nextHttpBackend.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="dropdown-container">
      <select id="languageDropdown" class="dropdown">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
      <select id="modelDropdown" class="dropdown">
        <option value="Pony">Pony</option>
        <option value="SDXL">SDXL</option>
      </select>
    </div>
    <div class="upper-section">
      <div class="column column-2">
        <h3>カテゴリ</h3>
        <div id="tag1Container" class="scroll-area"></div>
      </div>
      <div class="column column-6">
        <h3>中項目以降</h3>
        <div id="tagLevels" class="scroll-area"></div>
      </div>
      <div class="column column-2">
        <h3>選択されたプロンプト</h3>
        <div id="selectedTags" class="scroll-area"></div>
      </div>
    </div>
    <div id="imageContainer"></div>
  </div>

  <script>
    let data = {
    };

    let currentPath = [];
    let selectedTagGroups = [];
    let selectedImages = [];
    let imageCache = new Map();

document.addEventListener('DOMContentLoaded', initializeUI);

function initializeUI() {
  const languageDropdown = document.getElementById('languageDropdown');
  const modelDropdown = document.getElementById('modelDropdown');
  languageDropdown.addEventListener('change', () => loadJson());
  modelDropdown.addEventListener('change', () => loadJson());

  // 初期設定のJSONを取得
  loadJson();

  showTag1();
}

    function loadJson() {
      const language = document.getElementById('languageDropdown').value;
      const model = document.getElementById('modelDropdown').value;
      const filename = `json/prompt_${model.toLowerCase()}_${language}.json`;

      fetch(filename)
        .then(response => response.json())
        .then(jsonData => {
          data = jsonData;
          currentPath = [];
          selectedTagGroups = [];
          selectedImages = [];
          showTag1();
          updateSelectedTagsDisplay();
          updateImageDisplay();
        })
        .catch(error => console.error('Error loading JSON:', error));
    }

    function showTag1() {
      const tag1Container = document.getElementById('tag1Container');
      tag1Container.innerHTML = ''; // Clear existing buttons
      Object.keys(data).forEach(tag => {
        if (tag === "hr") {
          const hr = document.createElement('hr');
          tag1Container.appendChild(hr);
        } else {
          const button = createButton(tag, 1);
          button.addEventListener('click', () => selectTag(tag, 0, data[tag]));
          tag1Container.appendChild(button);
        }
      });
    }

    function createButton(text, level, url) {
      const button = document.createElement('button');
      button.classList.add('tag-button', `tag${level}-button`);
      if (url) {
        const placeholder = document.createElement('div');
        placeholder.classList.add('image-placeholder');
        placeholder.textContent = '読み込み中...';
        button.appendChild(placeholder);

        loadImage(url).then(img => {
          placeholder.remove();
          button.insertBefore(img, button.firstChild);
        }).catch(() => {
          placeholder.textContent = '画像を読み込めません';
        });
      }
      const span = document.createElement('span');
      span.textContent = text;
      button.appendChild(span);
      return button;
    }

    function loadImage(url) {
      if (imageCache.has(url)) {
        return Promise.resolve(imageCache.get(url).cloneNode());
      }

      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          imageCache.set(url, img);
          resolve(img.cloneNode());
        };
        img.onerror = reject;
        img.src = url;
        img.alt = "";
        img.style.maxWidth = '180px';
        img.style.maxHeight = '180px';
        img.style.display = 'block';
        img.style.margin = '0 auto 5px';
      });
    }

    function showTags(currentData, level) {
      const tagLevels = document.getElementById('tagLevels');

      // Clear all levels from the current one
      while (tagLevels.children.length > level) {
        tagLevels.removeChild(tagLevels.lastChild);
      }

      const levelContainer = document.createElement('div');

      Object.keys(currentData).forEach(tag => {
        const url = currentData[tag].url || (typeof currentData[tag] === 'object' && currentData[tag].hasOwnProperty('url') ? currentData[tag].url : null);
        const button = createButton(tag, level + 1, url);
        button.addEventListener('click', () => selectTag(tag, level, currentData[tag]));
        levelContainer.appendChild(button);
      });

      tagLevels.appendChild(levelContainer);
    }

    function selectTag(tag, level, data) {
      // Clear existing tags from the selected level
      const tagLevels = document.getElementById('tagLevels');
      while (tagLevels.children.length > level) {
        tagLevels.removeChild(tagLevels.lastChild);
      }

      currentPath = currentPath.slice(0, level);
      currentPath.push(tag);

      if (typeof data === 'object' && !data.hasOwnProperty('Desc')) {
        showTags(data, level + 1);
      } else {
        finishSelection(tag, data);
      }
    }

    function finishSelection(tag, item) {
      addSelectedTag(tag);
      addImage(item.url);
      currentPath = [];
    }

    function addSelectedTag(tag) {
      selectedTagGroups.push(tag);
      updateSelectedTagsDisplay();
    }

    function updateSelectedTagsDisplay() {
      const selectedTagsElement = document.getElementById('selectedTags');
      selectedTagsElement.innerHTML = ''; // Clear existing tags
      selectedTagGroups.forEach((tag, index) => {
        const groupElement = document.createElement('span');
        groupElement.classList.add('selected-tag-group');
        groupElement.textContent = tag;
        const removeButton = document.createElement('span');
        removeButton.classList.add('remove-tag');
        removeButton.textContent = '×';
        removeButton.addEventListener('click', () => removeTagGroup(index));
        groupElement.appendChild(removeButton);
        selectedTagsElement.appendChild(groupElement);
      });
    }

    function removeTagGroup(index) {
      selectedTagGroups.splice(index, 1);
      selectedImages.splice(index, 1);
      updateSelectedTagsDisplay();
      updateImageDisplay();
    }

    function addImage(url) {
      selectedImages.push(url);
      updateImageDisplay();
    }

    function updateImageDisplay() {
      const imageContainer = document.getElementById('imageContainer');
      imageContainer.innerHTML = ''; // Clear existing images
      selectedImages.forEach(url => {
        if (url) {
          loadImage(url).then(img => {
            img.style.width = '180px';
            img.style.height = '180px';
            img.style.objectFit = 'contain';
            img.style.margin = '2px';
            img.style.border = '1px solid #444';
            img.style.borderRadius = '5px';
            imageContainer.appendChild(img);
          }).catch(() => {
            console.error('Failed to load image:', url);
          });
        }
      });
    }
  </script>
</body>

</html>
